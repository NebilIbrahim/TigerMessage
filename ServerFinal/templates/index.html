<!doctype html>
<html>
  <head>
    <title>Tiger Message!</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: rgb(210,190,180); padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; background:rgb(240,230,210);}
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">  
  <body>
    <ul id="token"></ul>
    <button id="new_chat"><-</button><button id="change_name">Rename</button><button id="restrict">Subject</button>
    <div class="w3-card-4" style="background:rgb(210,190,180);">
      <header class="w3-container" style="background:rgb(200,180,170);">
        <h3 id="cur_chat"></h3>
      </header>
      <div class="w3-container">
        <div id="messages" style="overflow:auto;height:85vh;"></div>
      </div>
    </div>
    <form id="form" action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      function setCookie(cname, cvalue, exdays) {
          var d = new Date();
          d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
          var expires = "expires="+d.toUTCString();
          document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }

      function getCookie(cname) {
          var name = cname + "=";
          var decodedCookie = decodeURIComponent(document.cookie);
          var ca = decodedCookie.split(';');
          for(var i = 0; i <ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') {
                  c = c.substring(1);
              }
              if (c.indexOf(name) == 0) {
                  return c.substring(name.length, c.length);
              }
          }
          return "";
      }

      function checkCookie() {
          var username = getCookie("uid");
          if (username != "") {
              alert("Welcome again " + username);
          } else {
              username = prompt("Please enter your name:", "");
              if (username != "" && username != null) {
                  setCookie("uid", username, 0.01);
              }
          }
      }

      function formatMessage(user, msg, mine) {
          if (mine)
              return "<div class=\"w3-row\"><div class=\"w3-panel w3-third\"></div><div class=\"w3-panel w3-light-blue w3-round-xlarge w3-rest w3-padding-16 w3-mobile\">" + user + ": " + msg + "</div></div>";
          else
              return "<div class=\"w3-row\"><div class=\"w3-panel w3-twothird w3-light-grey w3-round-xlarge w3-padding-16 w3-mobile\">" + user + ": " + msg + "</div></div>";
      }

      function checkFormatLink(x) {
          var exp = /[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi;
          var regex = new RegExp(exp);

          if (x.match(regex)) {
              if (x.endsWith(".png") || x.endsWith(".jpg") || x.endsWith(".gif") ||
                  x.endsWith(".JPG")) {
                  return "<img src=\"" + (x.startsWith("www") ? "http:////" + x : x) + "\" height=\"300\">" + "</img>";
              } else {
                  return "<a href=\"" + (x.startsWith("www") ? "http:////" + x : x) + "\">" + x + "</a>";  
              }
          } else {
              return x;
          }
      }

      function notifyMe(message) {
          // Let's check if the browser supports notifications
          console.log("FOO!");

          if (!("Notification" in window)) {
              console.log("This browser does not support system notifications");
          }

          // Let's check whether notification permissions have already been granted
          else if (Notification.permission === "granted") {
              // If it's okay let's create a notification
              var notification = new Notification(message);
          }

          // Otherwise, we need to ask the user for permission
          else if (Notification.permission !== 'denied')
              Notification.requestPermission();
          if (Notification.permission === "granted")
              var notification = new Notification(message);
      }

      $(function () {
          var socket = io();
          var token = -1;
          var username;
          var chat;
          var restricted = false;

          $('form').submit(function(e){
              e.preventDefault(); // prevents page reloading
              socket.emit('chat message', $('#m').val(), username, chat); // getCookie("uid")
              $('#m').val('');
              return false;
          });
          $('#new_chat').click(function(){
              location.href = "https://tmessage.herokuapp.com/"// "https://tmessage.herokuapp.com/";//socket.emit('new chat'); ATTN
          });
          $('#change_name').click(function(){
              socket.emit('change cname', chat, prompt("What's the new name?", ""));
          });
          $('#restrict').click(function() {
              if (!restricted) {
                  var subjectsStr = prompt("Which subject do you want to restrict to?", "");
                  var subjects = subjectsStr.split(",").map(function (s) {return s.trim()});
                  socket.emit('restrict', chat, ...subjects);
                  restricted = true;}
              else {
                  socket.emit('unrestrict', chat);
                  restricted = false;}
          });
          socket.on('disp', function(toDisp){
              alert(toDisp);
          });
          socket.on('chat message', function(sender, msg, isNew){
              var msgs = msg.split(/[ ]+/).map(x => checkFormatLink(x)/*((x.match(regex)) ?
                                                     ((x.endsWith(".png") || x.endsWith(".jpg") || x.endsWith(".gif")) ?
                                                      "<img src=\"" + (x.startsWith("www") ? "http:////" + x : x) + "\" height=\"300\">" + "</img>" :
                                                      "<a href=\"" + (x.startsWith("www") ? "http:////" + x : x) + "\">" + x + "</a>") : x)*/);
              var msgf = msgs.join(" ");
              $('#messages').append(formatMessage(sender, msgf, (sender == username)));
              $('#messages').scrollTop($('#messages')[0].scrollHeight);
                  //animate({ scrollTop: $('#messages').prop("scrollHeight")}, 1000);
              //console.log("**" + $('div.w3-panel').length.toString());
              console.log(document.hidden);
              if (sender != username && isNew && document.hidden)
                  notifyMe(sender + ": " + msg);
              if ($('div.w3-panel').length > 50)
                  $('#messages').find('div').first().remove();
              //$('#messages').append($('<li>').text(msg)); // TO CHANGE
          });
          socket.on('token', function(tok){
              token = tok;
              //checkCookie();
              //setCookie("uid", '{{username}}', 0.5);
              //username = getCookie("uid");//prompt("Please enter your name:", "");
              username = '{{username}}' // Temp
              chat = '{{to_chat}}'//prompt("Which chat do you want to access?", "");
              socket.emit('confirm', tok, username, chat);
              $('#token').insideHTML = tok;
          });
          socket.on('confirm', function(chat_name){
              $('#cur_chat').html(chat_name);
          });
          socket.on('clear', function() {
              while ($('div.w3-panel').length > 0)
                  $('#messages').find('div').first().remove();
          });
      });
      </script>
  </body>
</html>
